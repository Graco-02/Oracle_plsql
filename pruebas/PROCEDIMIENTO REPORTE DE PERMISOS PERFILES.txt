SET SERVEROUTPUT ON;
exec dbms_output.enable(NULL);
DECLARE
  CODENT_ENT        DEBUSAT.MPDT021.CODENT%TYPE;
  CODPERFIL_ANT     DEBUSAT.SGDT946.CODPERFIL%TYPE;
  NOMINTERNO_ANT    DEBUSAT.SGDT955.NOMINTERNO%TYPE;
  DESCRIPCION_SERV  DEBUSAT.MPDT304.DESTRANSA%TYPE;
  INDSRWEB_AUX      DEBUSAT.MPDT304.INDSERWEB%TYPE;
  INDPERMISOJA_AUX  DEBUSAT.SGDT956.INDPERMISOJA%TYPE;
  FILA_SGDT945      DEBUSAT.SGDT945%ROWTYPE;
  FILA_MPDT304      DEBUSAT.MPDT304%ROWTYPE;
  FILA_SGDT904      DEBUSAT.SGDT904%ROWTYPE;
  FILA_SGDT946      DEBUSAT.SGDT946%ROWTYPE;
  FILA_PERMISOS_TRANSACCIONES DEBUSAT.SGDT955%ROWTYPE;
  FILA_PERMISOS_FORNT DEBUSAT.SGDT956%ROWTYPE;

BEGIN
   CODENT_ENT:='0736';
   CODPERFIL_ANT:='  ';
   NOMINTERNO_ANT:='        ';
   
   /*IMPRIMO LOS HEADERS*/
   DBMS_OUTPUT.PUT_LINE('INSTALAC' ||';'|| 'CODPERFIL' ||';'|| 'FECALTA' ||';'|| 'FECBAJA'||';'||
                        'DESPERFIL'||';'||'DESPERRED'||';'||'TIPPERFIL'||';'||'INDMULTIENT'||';'||
                        'NOMINTERNO'||';'||'INDPERMISO'||';'||'DESTRANSA'||';'||'INDSERWEB'||';'||'INDPERMISOJA');
   
   FOR FILA_SGDT946 IN (SELECT * FROM DEBUSAT.SGDT946 WHERE CODENT = CODENT_ENT ORDER BY CODPERFIL,INSTALAC) LOOP
    
    /*SOLO ACCCEDO A LA SGDT945 CUANDO CAMBIO DE PERFIL*/
    IF FILA_SGDT946.CODPERFIL <> CODPERFIL_ANT
      THEN 
      SELECT * INTO FILA_SGDT945 FROM DEBUSAT.SGDT945 WHERE DEBUSAT.SGDT945.INSTALAC=FILA_SGDT946.INSTALAC 
      AND DEBUSAT.SGDT945.CODPERFIL=FILA_SGDT946.CODPERFIL;
      CODPERFIL_ANT:=FILA_SGDT946.CODPERFIL;
    END IF;
     
     
     /*DESPLIEGO LOS PERMISOS A LOS SERVICIOS*/                        
     FOR FILA_PERMISOS_TRANSACCIONES IN (SELECT * FROM DEBUSAT.SGDT955 WHERE INSTALAC=FILA_SGDT946.INSTALAC AND CODPERFIL=FILA_SGDT946.CODPERFIL ORDER BY DEBUSAT.SGDT955.NOMINTERNO) LOOP
        /*SOLO ACCCEDO A LA MPDT304 CUANDO CAMBIO DE SERVICIO*/
        IF FILA_PERMISOS_TRANSACCIONES.NOMINTERNO <> NOMINTERNO_ANT
         THEN 
          NOMINTERNO_ANT:=FILA_PERMISOS_TRANSACCIONES.NOMINTERNO;
          DESCRIPCION_SERV:='NO EXISTE MPDT304';
          INDPERMISOJA_AUX:='X';
          
          
          FOR FILA_MPDT304 IN (SELECT * FROM DEBUSAT.MPDT304 
                               WHERE DEBUSAT.MPDT304.INSTALAC = FILA_PERMISOS_TRANSACCIONES.INSTALAC 
                               AND DEBUSAT.MPDT304.NOMINTERNO = FILA_PERMISOS_TRANSACCIONES.NOMINTERNO)
          LOOP
                               
                   IF DESCRIPCION_SERV <>    FILA_MPDT304.DESTRANSA 
                     THEN   
                       DESCRIPCION_SERV:= FILA_MPDT304.DESTRANSA; 
                       INDSRWEB_AUX:= FILA_MPDT304.INDSERWEB;
                   END IF;       
          
          END LOOP;
          
          IF DESCRIPCION_SERV='NO EXISTE MPDT304'
          THEN 
           DESCRIPCION_SERV:='NO EXISTE MPDT304/SGDT904';
           
           FOR FILA_MPDT304 IN (SELECT * FROM DEBUSAT.SGDT904 
                               WHERE DEBUSAT.SGDT904.INSTALAC = FILA_PERMISOS_TRANSACCIONES.INSTALAC 
                               AND DEBUSAT.SGDT904.NOMINTERNO = FILA_PERMISOS_TRANSACCIONES.NOMINTERNO)
          LOOP
                               
                   IF DESCRIPCION_SERV <>    FILA_MPDT304.DESTRANSA 
                     THEN   
                       DESCRIPCION_SERV:= FILA_MPDT304.DESTRANSA; 
                       INDSRWEB_AUX:= FILA_MPDT304.INDSERWEB;
                   END IF;       
          
          END LOOP;
          END IF;
          
          
        END IF;  
        
        
          FOR FILA_PERMISOS_FORNT IN (SELECT * FROM DEBUSAT.SGDT956 
                               WHERE DEBUSAT.SGDT956.INSTALAC = FILA_PERMISOS_TRANSACCIONES.INSTALAC 
                               AND DEBUSAT.SGDT956.NOMINTERNO = FILA_PERMISOS_TRANSACCIONES.NOMINTERNO
                               AND DEBUSAT.SGDT956.CODPERFIL = CODPERFIL_ANT)
          LOOP
                               
                   IF INDPERMISOJA_AUX <>    FILA_PERMISOS_FORNT.INDPERMISOJA 
                     THEN   
                       INDPERMISOJA_AUX:= FILA_PERMISOS_FORNT.INDPERMISOJA ;
                   END IF;       
          
          END LOOP;
        
        
        DBMS_OUTPUT.PUT_LINE(FILA_SGDT946.INSTALAC ||';'||
                             FILA_SGDT946.CODPERFIL ||';'||
                             FILA_SGDT946.FECALTA ||';'||
                             FILA_SGDT946.FECBAJA ||';'||
                             FILA_SGDT945.DESPERFIL ||';'||
                             FILA_SGDT945.DESPERRED||';'||
                             FILA_SGDT945.TIPPERFIL||';'||
                             FILA_SGDT945.INDMULTIENT||';'||
                             FILA_PERMISOS_TRANSACCIONES.NOMINTERNO||';'|| 
                             FILA_PERMISOS_TRANSACCIONES.INDPERMISO||';'||
                             DESCRIPCION_SERV||';'||
                             INDSRWEB_AUX||';'||
                             INDPERMISOJA_AUX);
                         
     END LOOP;
   END LOOP;
END;















